
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Darkof</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Darkof">
<meta property="og:url" content="https://www.darkof.com/index.html">
<meta property="og:site_name" content="Darkof">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Darkof">
<meta name="twitter:creator" content="@https:&#x2F;&#x2F;www.twitter.com&#x2F;wenxiaobin">
  
    <link rel="alternative" href="/atom.xml" title="Darkof" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37387757-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->

</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Darkof</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Adam Wen&#39;s Blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="www.darkof.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-decorator-pits" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/18/decorator-pits/" class="article-date">
  <time datetime="2017-02-18T07:56:23.000Z" itemprop="datePublished">2017-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/18/decorator-pits/">Python Decorator 的一些小细节/坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Decorator-的本质是什么？"><a href="#Decorator-的本质是什么？" class="headerlink" title="Decorator 的本质是什么？"></a>Decorator 的本质是什么？</h2><p>decorator 本质就是一个接收<strong>对象</strong>的<strong>对象</strong>(对，是个对象，而不是大多数人认为的函数)，更多的资料可以参照 <a href="http://darkof.com/2017/01/20/-e7-90-86-e8-a7-a3python-e7-9a-84-e8-a3-85-e9-a5-b0-e5-99-a8/" target="_blank" rel="noopener">理解Python的装饰器 | Darkof</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final_func = decorator(wrapped_function) <span class="comment"># 与注释部分的实质是一致的。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@decorator</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped_func</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<h2 id="被装饰的函数与之前相比，改变了什么？"><a href="#被装饰的函数与之前相比，改变了什么？" class="headerlink" title="被装饰的函数与之前相比，改变了什么？"></a>被装饰的函数与之前相比，改变了什么？</h2><h3 id="行为"><a href="#行为" class="headerlink" title="行为"></a>行为</h3><p>这个是最显而易见的，装饰器可以在原函数执行之前或之后添加额外的行为</p>
<h3 id="函数本身的属性"><a href="#函数本身的属性" class="headerlink" title="函数本身的属性"></a>函数本身的属性</h3><p>如果你简单的实现了下面的 decorator 会改变什么呢<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"in decorator"</span></span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bar</span><span class="params">(object)</span>:</span>  <span class="comment"># 原谅我用小写的 bar :)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        self.func= func</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"in decorator"</span></span><br><span class="line">        <span class="keyword">return</span> self.func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@foo</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f1</span><span class="params">(a)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> a</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> f1.__name__</span><br><span class="line"><span class="comment">#输出: 'wrapped'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@bar</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f2</span><span class="params">(a)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> a</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> f2.__name__</span><br><span class="line"><span class="comment"># AttributeError              Traceback (most recent call last)</span></span><br><span class="line"><span class="comment"># &lt;ipython-input-9-dff5600c49e8&gt; in &lt;module&gt;()</span></span><br><span class="line"><span class="comment"># ----&gt; 1 f2.__name__</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># AttributeError: 'bar' object has no attribute '__name__'</span></span><br></pre></td></tr></table></figure></p>
<p>从上面我们看出来，函数的 <code>__name__</code> 属性也发生了变化，这也是为什么我们推荐装饰器的时候使用 fucntools.wraps</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @functools.wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"in decorator"</span></span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br></pre></td></tr></table></figure>
<p><code>wraps</code> 会把原函数的属性赋给新的 wrapped 这个函数（主要会同步的属性为 <code>__name__</code>, <code>__module__</code>, <code>__doc__</code>, <code>__dict__</code>, 当然，你也可以添加你希望同步的属性）</p>
<h3 id="函数的参数"><a href="#函数的参数" class="headerlink" title="函数的参数"></a>函数的参数</h3><p>是的，很少有人会注意到被装饰过会，函数接收的参数也会产生变化<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">inspect.getargspec(f1)</span><br><span class="line"><span class="comment"># 输出 ArgSpec(args=[], varargs='args', keywords='kwargs', defaults=None)</span></span><br><span class="line"></span><br><span class="line">inspect.getargspec(f2)</span><br><span class="line"><span class="comment"># TypeError                   Traceback (most recent call last)</span></span><br><span class="line"><span class="comment"># &lt;ipython-input-16-bff760b02fba&gt; in &lt;module&gt;()</span></span><br><span class="line"><span class="comment"># ----&gt; 1 inspect.getargspec(f2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/inspect.pyc in getargspec(func)</span></span><br><span class="line"><span class="comment">#     814         func = func.im_func</span></span><br><span class="line"><span class="comment">#     815     if not isfunction(func):</span></span><br><span class="line"><span class="comment"># --&gt; 816         raise TypeError('&#123;!r&#125; is not a Python function'.format(func))</span></span><br><span class="line"><span class="comment">#     817     args, varargs, varkw = getargs(func.func_code)</span></span><br><span class="line"><span class="comment">#     818     return ArgSpec(args, varargs, varkw, func.func_defaults)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TypeError: &lt;__main__.bar object at 0x108729f50&gt; is not a Python function</span></span><br></pre></td></tr></table></figure></p>
<p>f1 接收的函数名从 a 变成了 args 和 kwargs, f2 干脆就拿不到了，这也意味着其实装饰器并不能做到 works anywhere（毕竟有很多装饰器会通过参数来判断这是不是一个 classmethod，然后两个装饰器混用可能会导致其中一个失效）</p>
<h2 id="装饰-classmethod-staticmethod"><a href="#装饰-classmethod-staticmethod" class="headerlink" title="装饰 classmethod/staticmethod"></a>装饰 classmethod/staticmethod</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"in decorator"</span></span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">     @foo</span></span><br><span class="line"><span class="meta">     @classmethod</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">duck</span><span class="params">(cls)</span>:</span></span><br><span class="line">         <span class="keyword">print</span> <span class="string">'Yooooooooooo!'</span></span><br><span class="line"></span><br><span class="line">Bar.duck()</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># TypeError                                 Traceback (most recent call last)</span></span><br><span class="line"><span class="comment"># &lt;ipython-input-19-ddf54c241cc4&gt; in &lt;module&gt;()</span></span><br><span class="line"><span class="comment"># ----&gt; 1 Bar.duck()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># TypeError: unbound method wrapped() must be called with Bar instance as first argument (got nothing instead)</span></span><br></pre></td></tr></table></figure>
<p>当我们尝试用之前实现的 decorator 来装饰 classmethod 的时候，会遇到 TypeError，原因是 classmethod/staticmethod 本质是一个 Descriptor 而非 function，我们在一开始提到这样一句话:</p>
<blockquote>
<p>decorator 本质就是一个接收<strong>对象</strong>的<strong>对象</strong></p>
</blockquote>
<p>在前面也聊到了，decorator 是个对象，可能是个 class 或是 function, 那么他接收的是什么呢，很多人认为 decorator 接受的是函数，然而严格来说，decorator 接收的是一个<strong>对象</strong></p>
<p>当我们知道 classmethod/staticmehtod 是 Descriptor 之后就很容易的知道如何写一个装饰 Descriptor(当然，你需要先了解什么是 <a href="https://docs.python.org/2/howto/descriptor.html" target="_blank" rel="noopener">Descriptor</a>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bar</span><span class="params">(object)</span>:</span>  <span class="comment"># 原谅我用小写的 bar :)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        self.func= func</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"in decorator"</span></span><br><span class="line">        <span class="keyword">return</span> self.func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        func = self.func.__get__(instance, owner)</span><br><span class="line">        <span class="keyword">return</span> bar(func)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> bar(self.func)(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Duck</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">    @foo</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fly</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'fly'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @foo</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'run'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @foo</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'stop'</span></span><br><span class="line"></span><br><span class="line">Duck.fly()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># in decorator</span></span><br><span class="line"><span class="comment"># fly</span></span><br><span class="line"></span><br><span class="line">Duck.run()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># in decorator</span></span><br><span class="line"><span class="comment"># run</span></span><br><span class="line"></span><br><span class="line">Duck().stop()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># in decorator</span></span><br><span class="line"><span class="comment"># stop</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2017/02/18/decorator-pits/" data-id="cjbweuab3003wpdwcm7ev5qlq" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2017/02/18/decorator-pits/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/decorator/">decorator</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql-offset" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/14/mysql-offset/" class="article-date">
  <time datetime="2016-08-14T10:43:37.000Z" itemprop="datePublished">2016-08-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/14/mysql-offset/">mysql offset 为什么这么慢。。。</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前从来没觉得 offset 有什么坑，也没有细想过 mysql 的 offset 的实现原理。</p>
<p>直到这周打算把 4000w+ 的数据热到 redis 中，写了一个脚本,  主要的代码大概如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> table  <span class="comment"># Mysql Table Object</span></span><br><span class="line"></span><br><span class="line">redis_cli = Redis(xxxxxxxxxxx)</span><br><span class="line"></span><br><span class="line">CUR = <span class="number">0</span></span><br><span class="line">MAX = <span class="number">40000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> CUR &lt;= MAX:</span><br><span class="line">    query = text(<span class="string">"""SELECT id FROM example</span></span><br><span class="line"><span class="string">                    LIMIT CUR, 1000</span></span><br><span class="line"><span class="string">                    ORDER BY id DESC"""</span>)</span><br><span class="line">    result = table.execute(query).fetchall()</span><br><span class="line">    pipe = redis_cli.pipeline()  <span class="comment"># 使用 pipeline 来减少连接开销</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> result:</span><br><span class="line">         pipe.set(item.id, <span class="string">'foo'</span>)</span><br><span class="line">    pipe.execute()</span><br><span class="line">    CUR += <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p>开始执行大概下午 6 点左右，然后我就去吃饭逗猫写代码又睡了一觉。</p>
<p>上午 11 点左右来公司发现，才完成了 1000w 左右的数据，内心是崩溃的。。。。。</p>
<p>看了一眼 slow log，一次 Mysql 的查询需要 40s， 然后开始查一些资料找原因，发现 offset/limit 根本无法用到 index 机制，而是读整张表，然后数到需要便宜的位置，所以上面的代码到 1000w 时， mysql 会按照 id 的顺序逐条累加，一直找到第 1000w 的位置（至于为什么不通过 index 来直接找到 id 为 10000000 的数据，原因很简单，id 为 10000000 的数据并不已经代表是第 1000w 条数据，中间有可能会有数据被删除使得 id 非连续）。</p>
<p>找到了原因重写了一把脚本，把 offset 改成 where 就解决了这个问题，然后用了半个小时就跑完了数据- -。</p>
<p>thumbnail</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2016/08/14/mysql-offset/" data-id="cjbweuab5003ypdwcwbchntbd" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2016/08/14/mysql-offset/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python-global-var" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/04/python-global-var/" class="article-date">
  <time datetime="2016-08-03T16:05:28.000Z" itemprop="datePublished">2016-08-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/04/python-global-var/">Python 中的「全局变量」的小细节</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前几天被同学问了一个问题，为什么自己修改修改了全局变量但是没有生效，例子如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: foo.py</span></span><br><span class="line">l = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> l</span><br><span class="line">  l = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: main.py</span></span><br><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> l, bar</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  <span class="keyword">print</span> l</span><br><span class="line">  bar()</span><br><span class="line">  <span class="keyword">print</span> l</span><br><span class="line"></span><br><span class="line">输出:</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure></p>
<p>所以我们还是要弄明白什么是全局变量。。。</p>
<h2 id="Python-有全局变量么"><a href="#Python-有全局变量么" class="headerlink" title="Python 有全局变量么"></a>Python 有全局变量么</h2><p>有 - -|||。。。。。。<br>有两种情况是全局变量:</p>
<ul>
<li>在当前文件中的最外层作用于声明的变量为全局变量</li>
<li>用 global 声明的变量为全局变量</li>
</ul>
<h2 id="Python-的「全局变量」的作用域是多大"><a href="#Python-的「全局变量」的作用域是多大" class="headerlink" title="Python 的「全局变量」的作用域是多大"></a>Python 的「全局变量」的作用域是多大</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># foo.py</span></span><br><span class="line">l = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  b = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">--------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># In ipython</span></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> foo</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: <span class="string">'l'</span> <span class="keyword">in</span> foo.__dict__</span><br><span class="line">Out[<span class="number">2</span>]: <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: <span class="string">'b'</span> <span class="keyword">in</span> foo.__dict__</span><br><span class="line">Out[<span class="number">3</span>]: <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: foo.bar()</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="string">'b'</span> <span class="keyword">in</span> foo.__dict__</span><br><span class="line">Out[<span class="number">5</span>]: <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>从上面的代码里我们得到以下几个结论</p>
<ul>
<li>全局变量的作用域被绑定到所在文件之下</li>
<li>即使是先加载再声明全局变量，依然会绑定到该文件之中</li>
</ul>
<h2 id="为什么我不能跨文件修改全局变量"><a href="#为什么我不能跨文件修改全局变量" class="headerlink" title="为什么我不能跨文件修改全局变量"></a>为什么我不能跨文件修改全局变量</h2><p>其实，正确的来说，这个问题问的并没有切中要点，在最初的代码中，我们无法修改 l 的主要原因是 <a href="https://docs.python.org/2/reference/simple_stmts.html#import" target="_blank" rel="noopener">import</a> 的特性导致</p>
<blockquote>
<p>The from form does not bind the module name: it goes through the list of identifiers, looks each one of them up in the module found in step (1), and binds the name in the local namespace to the object thus found.</p>
</blockquote>
<p>所以当你执行这个语句<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> l</span><br></pre></td></tr></table></figure></p>
<p>本质是在当前的 Namespace 中声明了变量 <code>l</code>, 并将 <code>l</code> 指向 foo 这个 module 中的 l 所指向的对象。</p>
<p>当你执行 <code>foo.bar()</code> 的时候，将 foo 中的 <code>l</code> 改为了 20, 但是 main.py 中 <code>l</code> 扔指向 10，所以并没有实现夸文件修改.<br>同理，在 main.py 中修改 <code>l</code> 也不会影响 <code>foo.l</code></p>
<h2 id="最后的最后"><a href="#最后的最后" class="headerlink" title="最后的最后"></a>最后的最后</h2><p>虽然前面举了例子，有分析了原理，但是其实就像是聊屠龙术的运行原理（更何况「全局变量」连屠龙书都算不上，顶多算是这个图里的 <a href="http://paulhastings.me/wp-content/uploads/2011/12/If-Browsers-Were-Guns.jpg" target="_blank" rel="noopener">IE</a>）</p>
<p>除非是用来定义常量，否则不要在 Python 里用全局变量。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2016/08/04/python-global-var/" data-id="cjbweuac00067pdwcfa7euub9" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2016/08/04/python-global-var/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Avoiding-ISP-Caching" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/10/Avoiding-ISP-Caching/" class="article-date">
  <time datetime="2015-05-10T14:57:32.000Z" itemprop="datePublished">2015-05-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/10/Avoiding-ISP-Caching/">运营商缓存导致的奇葩问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>很久之前遇到的一个问题, 趁还记得, 记录下来, 避免日后忘记.</p>
<p>在公司上线 2014特别项目 之后, 有用户反馈出现了穿好问题. 这个这问题之前从来没有出现过.</p>
<p>通过检查服务器端未出现 Session 冲突, 用户在主站访问正常, 但是在进入 2014 项目之后, 发现信息出现串号现象.</p>
<p>我们的用户信息的 API 请求地址的格式类似为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user_data.json</span><br></pre></td></tr></table></figure></p>
<p>所有用户都会请求这个地址, 然后由服务器动态生成 Response 并返回, 通过在线上检查发现返回的数据也没有错误. </p>
<p>后来又发现, 遇到的串号用户基本上集中在相同的几个地区. 通过这个线索, 发现问题是出在 ISP服务商 的环节, 有些小的运营商会对你的静态数据做 cache 来加快用户访问速度, 即使你加了 no-cache 的设置, 但是仍然会有些运营商不按照规范强行缓存.</p>
<p>临时的解决方法就是讲请求地址改为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user_data.json?_=[unix_timestamp]</span><br></pre></td></tr></table></figure></p>
<p>利用 UNIX时间戳 来避开运营商缓存的问题, 最终问题得以解决.</p>
<p>作为总结, 在以后设计 API 的时候尽量要将每个用户的请求地址设计为独一无二的地址, 避免服务器对同一地址动态生成不同的数据, 最终避开这个问题.</p>
<p>PS:<br>想对运营商说….Fuck!</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2015/05/10/Avoiding-ISP-Caching/" data-id="cjbweuaao002ypdwcvk2m2jb1" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2015/05/10/Avoiding-ISP-Caching/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/运营商缓存/">运营商缓存</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-amazon-s3-boto-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/06/amazon-s3-boto-note/" class="article-date">
  <time datetime="2015-03-06T08:17:33.000Z" itemprop="datePublished">2015-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/06/amazon-s3-boto-note/">Amazon S3 的坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前就遇到过一次, 今天又有同事遇到, 总之 boto 是个很神奇的项目, 超多 issue 而且跟着文档走 S3 基本不可用, 经常会遇到 400 错误 T_T. 所以单独记录下.</p>
<p>正确的连接 boto:<br>首先在目录下创建 .boto 文件, 写入 access key 和 secret key:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Credentials]</span><br><span class="line">aws_access_key_id = YOURID</span><br><span class="line">aws_secret_access_key = YOURKEY</span><br></pre></td></tr></table></figure></p>
<p>然后连接的时候要注意设置 validate 为 False:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto.s3</span><br><span class="line"><span class="keyword">from</span> boto.s3.connection <span class="keyword">import</span> Location</span><br><span class="line">c = boto.s3.connect_to_region(Location.CNNorth1)</span><br><span class="line">c.get_bucket(BUCKET_NAME, validate=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2015/03/06/amazon-s3-boto-note/" data-id="cjbweuaar0035pdwc83gp84eg" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2015/03/06/amazon-s3-boto-note/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/">aws</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/s3/">s3</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python-float" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/23/python-float/" class="article-date">
  <time datetime="2014-11-23T09:26:29.000Z" itemprop="datePublished">2014-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/23/python-float/">Python与浮点数</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在周六参加 TDD Workshop 的时候, 遇到一个问题就是因为涉及到浮点数运算导致单元测试迟迟通不过- -. 回来就在这方面查了查</p>
<p>#简单的例子<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="number">0.1</span> + <span class="number">0.2</span> == <span class="number">0.3</span></span><br><span class="line">Out[<span class="number">1</span>]: <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: round(<span class="number">2.675</span>, <span class="number">2</span>)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">2.67</span></span><br></pre></td></tr></table></figure></p>
<p>简单说这个就是因为浮点数的问题引起的, 也导致我们浮点数的单元测试没有通过.</p>
<p>#关于浮点数<br>不管是什么数, 在计算机中最终都会被转化为 0 和 1 进行存储, 所以我们需要先弄明白以下几点问题</p>
<ul>
<li>一个小数如何转化为二进制</li>
<li>浮点数的二进制如何存储</li>
</ul>
<p>##浮点数的二进制表示<br>首先我们要了解浮点数二进制表示, 有以下两个原则:  </p>
<ul>
<li>整数部分对 2 取余然后逆序排列</li>
<li>小数部分乘 2 取整数部分, 然后顺序排列</li>
</ul>
<h3 id="2-25-的二进制表示是"><a href="#2-25-的二进制表示是" class="headerlink" title="2.25 的二进制表示是?"></a>2.25 的二进制表示是?</h3><p>整数部分的二进制表示为 10, 小数部分我们逐步来算<br>0.25 * 2 = 0.5        整数部分取 0<br>0.5 * 2 = 1.0        整数部分取 1<br>所以 2.25 的二进制表示为 10.01</p>
<h3 id="0-1-的表示是什么"><a href="#0-1-的表示是什么" class="headerlink" title="0.1 的表示是什么?"></a>0.1 的表示是什么?</h3><p>我们继续按照浮点数的二进制表示来计算<br>0.1 * 2 = 0.2        整数部分取 0<br>0.2 * 2 = 0.4        整数部分取 0<br>0.4 * 2 = 0.8        整数部分取 0<br>0.8 * 2 = 1.6        整数部分取 1<br>0.6 * 2 = 1.2        整数部分取 1<br>0.2 * 2 = 0.4        整数部分取 0<br>…</p>
<p>所以你会发现, 0.1 的二进制表示是 0.00011001100110011001100110011……0011<br>0011作为二进制小数的循环节不断的进行循环.</p>
<p>这就引出了一个问题, 你永远不能存下 0.1 的二进制, 即使你把全世界的硬盘都放在一起, 也存不下 0.1 的二进制小数.</p>
<p>##浮点数的二进制存储<br>Python 和 C 一样, 采用 <a href="http://www.cs.berkeley.edu/~wkahan/ieee754status/IEEE754.PDF" target="_blank" rel="noopener">IEEE 754</a> 规范来存储浮点数. <a href="http://www.cs.berkeley.edu/~wkahan/ieee754status/IEEE754.PDF" target="_blank" rel="noopener">IEEE 754</a> 对双精度浮点数的存储规范将 64 bit 分为 3 部分.</p>
<ul>
<li>第 1 bit 位用来存储 符号, 决定这个数是正数还是负数</li>
<li>然后使用 11 bit 来存储指数部分</li>
<li>剩下的 52 bit 用来存储尾数<br><img src="http://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/IEEE_754_Double_Floating_Point_Format.svg/1236px-IEEE_754_Double_Floating_Point_Format.svg.png" alt="Double-precision_floating-point_format"></li>
</ul>
<p>而且可以指出的是, double 能存储的数的个数是有限的, double 能代表的数必然不超过 2^64 个, 那么现实世界上有多少个小数呢? 无限个. 计算机能做的只能是一个接近这个小数的值, 是这个值在一定精度下与逻辑认为的值相等. 换句话说, 每个小数的存储(但是不是所有的), 都会伴有精度的丢失.</p>
<p>#浮点数计算的问题</p>
<p>现在我们可以看一开始提到的例子</p>
<h2 id="0-1-0-2-0-3"><a href="#0-1-0-2-0-3" class="headerlink" title="0.1 + 0.2 == 0.3"></a>0.1 + 0.2 == 0.3</h2><p>≈<br>0.1 在 Python 中真正的数字是 0.1000000000000000055511151231257827021181583404541015625<br>0.2 在 Python 中真正的数字是 0.200000000000000011102230246251565404236316680908203125<br>0.3 在 Python 中真正的数字是 0.299999999999999988897769753748434595763683319091796875</p>
<p>这就是为什么 0.1 + 0.2 != 0.3 的原因</p>
<h2 id="round-2-675-2"><a href="#round-2-675-2" class="headerlink" title="round(2.675, 2)"></a>round(2.675, 2)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">4</span>]: round(<span class="number">2.675</span>, <span class="number">2</span>)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">2.67</span></span><br></pre></td></tr></table></figure>
<p>为什么 2.675 精确两位小数之后不是 2.68 呢, 因为 2.675 在计算机中真正的数字是 2.67499999999999982236431605997495353221893310546875</p>
<p>坑啊坑.</p>
<p>#我是如何遇到了这个问题<br>简单地说是因为我理解错了 decimal 这个模块的用法.<br>我一开始的使用方式是<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">14</span>]: Decimal(<span class="number">2.675</span>) * Decimal(<span class="number">1.2</span>)</span><br><span class="line">Out[<span class="number">14</span>]: Decimal(<span class="string">'3.209999999999999668043315637'</span>)</span><br></pre></td></tr></table></figure></p>
<p>因为没有仔细看库手册导致的错误使用. 正确的用法是:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">15</span>]: Decimal(<span class="string">'2.675'</span>) * Decimal(<span class="string">'1.2'</span>)</span><br><span class="line">Out[<span class="number">15</span>]: Decimal(<span class="string">'3.2100'</span>)</span><br></pre></td></tr></table></figure></p>
<p>将字符串传入 Decimal, 而将数字直接传入, 它的效果是查看该数字在计算机中实际存储的数字.</p>
<p>#decimal是如何实现的计算精准<br>我粗略的过了一下 decimal 这个库的源代码, 这个根据 <a href="http://speleotrove.com/decimal/decarith.html" target="_blank" rel="noopener">General Decimal Arithmetic Specification</a> 来设计, 简单地说就是将传入的字符串记录符号, 记录一个大数(整数和小数部分直接拼接而成), 记录小数点位置, 然后重写这个类的 operation进行实现.</p>
<p>#参考<br><a href="http://stackoverflow.com/questions/14572101/using-decimal-in-python" target="_blank" rel="noopener">using-decimal-in-python</a><br><a href="http://legacy.python.org/dev/peps/pep-0327/" target="_blank" rel="noopener">PEP327 Decimal Data Type</a><br><a href="http://justjavac.com/codepuzzle/2012/11/11/codepuzzle-float-who-stole-your-accuracy.html" target="_blank" rel="noopener">代码之谜（五）- 浮点数（谁偷了你的精度？）</a><br><a href="http://en.wikipedia.org/wiki/Double-precision_floating-point_format" target="_blank" rel="noopener">Double-precision floating-point format</a><br><a href="https://docs.python.org/2/tutorial/floatingpoint.html" target="_blank" rel="noopener">Floating Point Arithmetic: Issues and Limitations</a><br><a href="http://www.cs.berkeley.edu/~wkahan/ieee754status/IEEE754.PDF" target="_blank" rel="noopener">IEEE 754</a><br><a href="https://github.com/python/cpython/blob/master/Lib/_pydecimal.py" target="_blank" rel="noopener">Decimal Code</a><br><a href="http://speleotrove.com/decimal/decarith.html" target="_blank" rel="noopener">General Decimal Arithmetic<br>Specification</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2014/11/23/python-float/" data-id="cjbweuabw0065pdwcluee358m" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2014/11/23/python-float/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/float/">float</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/浮点数/">浮点数</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-bye-dream" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/07/bye-dream/" class="article-date">
  <time datetime="2014-11-07T10:16:40.000Z" itemprop="datePublished">2014-11-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/07/bye-dream/">再见了, 我的梦想</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>就是这样, 豆厂</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2014/11/07/bye-dream/" data-id="cjbweuaat003cpdwcsrd275gj" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2014/11/07/bye-dream/#disqus_thread" class="article-comment-link">评论</a>
      

      
    </footer>
  </div>
  
</article>


  
    <article id="post-unicode-compatible" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/10/20/unicode-compatible/" class="article-date">
  <time datetime="2014-10-20T03:42:05.000Z" itemprop="datePublished">2014-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/10/20/unicode-compatible/">字符串在 Python 2.x 和 3.x 下的适配</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>给 <a href="https://github.com/nvie/rq" target="_blank" rel="noopener">RQ</a> 提交了一个 <a href="https://github.com/nvie/rq/pull/438" target="_blank" rel="noopener">Pull Request</a> 来解决 issue#437 .</p>
<p>最开始的提交 我做了以下的工作:</p>
<ul>
<li>找到问题所在</li>
<li>写新的单元测试</li>
<li>将相关串做 decode 操作</li>
<li>跑单元测试通过, 提交 Pull Request</li>
</ul>
<p>然后….就遇到问题了, Travis 跑完发现 Python2.x 下都没问题, 但是 Python3.x 都跑不过, 原因很简单, python3.x 的时候已经不区分 string 和 unicode, 统一采用 unicode, 因此也取消了 decode 方法. 那么我们如何来同时适配 2.x 和 3.x 版本呢. 我想过很多方法, 但是都觉得不够优雅, 后来还是在 RQ 这个库本身里找到了答案.</p>
<p>在 RQ 中, 对字符串的获取都会经过一个 as_text 的函数处理, 该函数位于 compat/__init__.py, 就是为了同时适配 2.x 和 3.x 版本, 函数如下:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> PY2:</span><br><span class="line">    <span class="comment"># Python 3.x and up</span></span><br><span class="line">    text_type = str</span><br><span class="line">    string_types = (str,)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_text</span><span class="params">(v)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">elif</span> isinstance(v, bytes):</span><br><span class="line">            <span class="keyword">return</span> v.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">elif</span> isinstance(v, str):</span><br><span class="line">            <span class="keyword">return</span> v</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Unknown type %r'</span> % type(v))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decode_redis_hash</span><span class="params">(h)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> dict((as_text(k), h[k]) <span class="keyword">for</span> k <span class="keyword">in</span> h)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Python 2.x</span></span><br><span class="line">    text_type = unicode</span><br><span class="line">    string_types = (str, unicode)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_text</span><span class="params">(v)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">return</span> v.decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decode_redis_hash</span><span class="params">(h)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> h</span><br></pre></td></tr></table></figure></p>
<p>首先通过 six 这个库来判断 Python 版本, 然后根据版本的不同, 声明 as_text 方法的具体实现, 这样在整个库在处理字符串时, 不需要考虑版本差异, 直接调用 as_text 进行处理即可.</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2014/10/20/unicode-compatible/" data-id="cjbweuac3006dpdwctfo1afhq" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2014/10/20/unicode-compatible/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unicode/">unicode</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pyenv-virtualenv" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/10/17/pyenv-virtualenv/" class="article-date">
  <time datetime="2014-10-17T08:36:18.000Z" itemprop="datePublished">2014-10-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/10/17/pyenv-virtualenv/">用了pyenv-virtualenv, 天黑都不怕</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前就有听大妈推荐过 <a href="http://https://github.com/yyuu/pyenv" target="_blank" rel="noopener">pyenv</a>. 最近给一个项目这个库提交 Pull Request, 但 Python3.X 的单元测试没有跑过, 而我的机器上没有 Python3.X, 也不想把现有的 Python2.7 替换掉, 所以就用起了这个库.</p>
<p>简单的说, pyenv 是一个Python管理工具, 这个是和我们常用的 virtualenv 有所不通, 前者是对 Python 的版本进行管理, 实现不同版本的切换和使用. 后者测试创建一个虚拟环境, 与系统环境以及其他 Python 环境隔离, 避免干扰.</p>
<p>安装方法我就不做赘述了, <a href="http://https://github.com/yyuu/pyenv/blob/master/README.md" target="_blank" rel="noopener">pyenv readme</a> 已经写的特别详尽</p>
<p>#pyenv使用方法<br>简单的说一下使用方法</p>
<p>##安装不同版本的 Python<br><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pyenv install &lt;version&gt; <span class="comment">#安装特定版本的 Python</span></span><br><span class="line">pyenv install 3.3.0     <span class="comment">#安装 Python 3.3.0</span></span><br></pre></td></tr></table></figure></p>
<p>当我的系统 Python 版本是 2.7, 但是有个 叫做 py3-project 需要用 Python3 来运行的时候, 只需要这样做:<br><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> py3-project         <span class="comment">#进入项目目录</span></span><br><span class="line">pyenv <span class="built_in">local</span> 3.3.0      <span class="comment">#将当前目录下的Python环境切换为3.3.0</span></span><br><span class="line">pyenv version          <span class="comment">#运行显示通过pyenv设置之后的python版本, 得到结果是3.3.0 </span></span><br><span class="line">python --version       <span class="comment">#查看Python版本, 得到结果也是3.3.0</span></span><br></pre></td></tr></table></figure></p>
<p>此时就可以通过 python3.3 来运行项目了, 才这个项目之外的目录运行 Python, 你会发现仍然是系统版本. 通过pyenv可以给不同的目录设置不同的 Python 版本, 还可以通过 pyenv global 这个命令切换整个全局的 Python版本. 赞爆了是不是. </p>
<p>#告别virtualenv<br>接下来, 再介绍一个工具, 配合pyenv, 让我告别了用了很久了virtualenv.这个工具叫做 <a href="https://github.com/yyuu/pyenv-virtualenv" target="_blank" rel="noopener">pyenv-virtualenv</a>, 安装方法依然跳过, 至于使用, 你只需要记住三条命令:<br><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyenv virtualenv 3.3.0 env    <span class="comment">#创建一个 Python 版本为 3.3.0 的环境, 环境叫做 env</span></span><br><span class="line">pyenv activate env_name       <span class="comment">#激活 env 这个环境, 此时 Python 版本自动变为 3.3.0, 且是独立环境</span></span><br><span class="line">pyenv deactivate              <span class="comment">#离开已经激活的环境</span></span><br></pre></td></tr></table></figure></p>
<p>嗯, 写完这篇继续去修复那段 Python3.X 下通不过单元测试的程序.</p>
<p>再见了, virtualenv.</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2014/10/17/pyenv-virtualenv/" data-id="cjbweuabt0061pdwc45w8cgps" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2014/10/17/pyenv-virtualenv/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pyenv/">pyenv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtualenv/">virtualenv</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-go-learning" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/10/13/go-learning/" class="article-date">
  <time datetime="2014-10-13T02:38:36.000Z" itemprop="datePublished">2014-10-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/go/">go</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/10/13/go-learning/">go语言学习(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>##包</p>
<p>###包的导入方法1:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>###包的导入方法2:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"math"</span></span><br></pre></td></tr></table></figure>
<p>作为 Pytonista, 更喜欢第 2 种方式 更加简洁.</p>
<p>##包的变量导出<br>Go 语言通过命名来确定该变量是否是可以导出到外部供别的包所使用.可以被导出的变量通过将变量名的首字母大写来标志确定.</p>
<p>##函数</p>
<p>###一个函数可以收 0 到任意多个参数. 接收的参数类型在参数名之后声明:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x <span class="keyword">int</span>, y <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> x+y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果一个函数接受的所有参数是同一个类型的时候, 那么可以不需要每一个参数都标明类型, 只需要在最后一个参数上标明类型就可以.<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x, y <span class="keyword">int</span>)</span></span>&#123; #当多个参数是同一类型时, 可以省略只声明一次.</span><br><span class="line">	<span class="keyword">return</span> x+y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###一个函数可以返回多个值<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(x, y <span class="keyword">int</span>)</span> <span class="title">int</span>, <span class="title">int</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> y, x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###go也可以对返回变量命名<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">split</span><span class="params">(sum <span class="keyword">int</span>)</span> <span class="params">(x, y <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">	x = sum * <span class="number">4</span> / <span class="number">9</span></span><br><span class="line">	y = sum - x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##变量</p>
<p>###变量声明<br>go 通过 var 关键字来声明变量, 和函数参数声明一致, 变量类型在变量名之后声明:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> c, python, java <span class="keyword">bool</span> #三个值都为<span class="keyword">bool</span>类型</span><br></pre></td></tr></table></figure></p>
<p>###变量初始化<br>变量可以在声明的时候立刻初始化:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i, j <span class="keyword">int</span> = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">var</span> c, python, java = <span class="literal">true</span>, <span class="literal">false</span>, <span class="string">"no!"</span></span><br></pre></td></tr></table></figure></p>
<p>###短变量声明<br>短变量声明是一个特殊的使用方法, 有以下特点:</p>
<ul>
<li>只能在函数内部使用</li>
<li>不需要var关键字和类型</li>
<li>类型通过赋值时隐式声明<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> i, j <span class="keyword">int</span> = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">	k := <span class="number">3</span></span><br><span class="line">	c, python, java = <span class="literal">true</span>, <span class="literal">false</span>, <span class="string">"No!"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>###变量类型<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>  <span class="keyword">int8</span>  <span class="keyword">int16</span>  <span class="keyword">int32</span>  <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">uint</span> <span class="keyword">uint8</span> <span class="keyword">uint16</span> <span class="keyword">uint32</span> <span class="keyword">uint64</span> <span class="keyword">uintptr</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span> <span class="comment">// alias for uint8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">rune</span> <span class="comment">// alias for int32</span></span><br><span class="line">     <span class="comment">// represents a Unicode code point</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">float32</span> <span class="keyword">float64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">complex64</span> <span class="keyword">complex128</span></span><br></pre></td></tr></table></figure></p>
<p>###常量<br>常量只能使用const关键字生成<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Pi = <span class="number">3.14</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://www.darkof.com/2014/10/13/go-learning/" data-id="cjbweuaaw003hpdwcbolcofw1" class="article-share-link">分享到</a>
      

      
        <a href="https://www.darkof.com/2014/10/13/go-learning/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/数据库/">数据库</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Uncategorized/">Uncategorized</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/code-snippet/">code snippet</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/code-snippet/django/">django</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/database/postgres/">postgres</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/django/">django</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/joke/">joke</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/joke/闲言/">闲言</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/闲言/">闲言</a><span class="category-list-count">16</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/404/" style="font-size: 10px;">404</a> <a href="/tags/Decorator/" style="font-size: 10px;">Decorator</a> <a href="/tags/Duck-Typing/" style="font-size: 10px;">Duck_Typing</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/OO/" style="font-size: 10px;">OO</a> <a href="/tags/Python/" style="font-size: 16.67px;">Python</a> <a href="/tags/Regex/" style="font-size: 10px;">Regex</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/aws/" style="font-size: 10px;">aws</a> <a href="/tags/cPickle/" style="font-size: 10px;">cPickle</a> <a href="/tags/chm/" style="font-size: 10px;">chm</a> <a href="/tags/decorator/" style="font-size: 10px;">decorator</a> <a href="/tags/django/" style="font-size: 13.33px;">django</a> <a href="/tags/django-meta/" style="font-size: 10px;">django meta</a> <a href="/tags/float/" style="font-size: 10px;">float</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/jekyell/" style="font-size: 10px;">jekyell</a> <a href="/tags/linux/" style="font-size: 13.33px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mock/" style="font-size: 10px;">mock</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/postgres/" style="font-size: 10px;">postgres</a> <a href="/tags/pyenv/" style="font-size: 10px;">pyenv</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/qdu/" style="font-size: 10px;">qdu</a> <a href="/tags/requests/" style="font-size: 10px;">requests</a> <a href="/tags/s3/" style="font-size: 10px;">s3</a> <a href="/tags/sae/" style="font-size: 10px;">sae</a> <a href="/tags/snippets/" style="font-size: 10px;">snippets</a> <a href="/tags/unicode/" style="font-size: 10px;">unicode</a> <a href="/tags/unittest/" style="font-size: 13.33px;">unittest</a> <a href="/tags/v2ex/" style="font-size: 10px;">v2ex</a> <a href="/tags/virtualenv/" style="font-size: 10px;">virtualenv</a> <a href="/tags/代码风格再烂也烂不过这个政策/" style="font-size: 10px;">代码风格再烂也烂不过这个政策</a> <a href="/tags/公益/" style="font-size: 10px;">公益</a> <a href="/tags/冷/" style="font-size: 10px;">冷</a> <a href="/tags/呓语/" style="font-size: 10px;">呓语</a> <a href="/tags/多态/" style="font-size: 10px;">多态</a> <a href="/tags/安全/" style="font-size: 10px;">安全</a> <a href="/tags/开源/" style="font-size: 10px;">开源</a> <a href="/tags/浮点数/" style="font-size: 10px;">浮点数</a> <a href="/tags/腾讯微博/" style="font-size: 10px;">腾讯微博</a> <a href="/tags/装饰器/" style="font-size: 10px;">装饰器</a> <a href="/tags/运营商缓存/" style="font-size: 10px;">运营商缓存</a> <a href="/tags/重载/" style="font-size: 10px;">重载</a> <a href="/tags/闲言/" style="font-size: 10px;">闲言</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">六月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">四月 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">十月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">九月 2012</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/18/decorator-pits/">Python Decorator 的一些小细节/坑</a>
          </li>
        
          <li>
            <a href="/2016/08/14/mysql-offset/">mysql offset 为什么这么慢。。。</a>
          </li>
        
          <li>
            <a href="/2016/08/04/python-global-var/">Python 中的「全局变量」的小细节</a>
          </li>
        
          <li>
            <a href="/2015/05/10/Avoiding-ISP-Caching/">运营商缓存导致的奇葩问题</a>
          </li>
        
          <li>
            <a href="/2015/03/06/amazon-s3-boto-note/">Amazon S3 的坑</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="https://twitter.com/eggacheliu" target="_blank">SpecialX</a>
          </li>
        
          <li>
            <a href="http://www.tifan.net" target="_blank">tifan blog</a>
          </li>
        
          <li>
            <a href="http://blog.myanthem.cn" target="_blank">wwbensky</a>
          </li>
        
          <li>
            <a href="http://daily.page7.me" target="_blank">Jerry Leo</a>
          </li>
        
          <li>
            <a href="http://blog.csdn.net/huntinggo" target="_blank">huntinggo</a>
          </li>
        
          <li>
            <a href="http://www.the5fire.com" target="_blank">the5fire</a>
          </li>
        
          <li>
            <a href="http://www.ifanr.com" target="_blank">ifanr</a>
          </li>
        
          <li>
            <a href="http://www.iwangzheng.com" target="_blank">王筝博客</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Adam Wen<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<script>
  var disqus_shortname = 'darkof';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>

</div>
</body>
</html>
